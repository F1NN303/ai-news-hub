<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI News Hub | Article</title>
  <meta name="description" content="Read the full article on AI News Hub.">
  <link rel="canonical" href="/post.html" />
  <!-- Tailwind & Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary:#0ea5e9; --secondary:#06b6d4; --dark:#0f172a; --light:#f8fafc; --accent:#818cf8;
    }
    body{font-family:'Inter',sans-serif;background:#f8fafc;color:#0f172a;transition:background-color .3s,color .3s}
    .dark body{background:#0f172a;color:#e2e8f0}
  </style>
</head>
<body class="bg-light dark:bg-dark">
  <main id="post-container" class="max-w-3xl mx-auto p-6"></main>
  <script>
    let currentUser = null;
    let currentPostId = null;

    function getCsrfToken() {
      const match = document.cookie.split('; ').find(c => c.startsWith('csrf='));
      return match ? match.split('=')[1].split('.')[0] : '';
    }

    async function ensureCsrfCookie() {
        if (!getCsrfToken()) {
          await fetch('/api/auth/csrf', { credentials: 'include' });
        }
    }

    function csrfFetch(url, options = {}) {
      const headers = options.headers || {};
      headers['X-CSRF-Token'] = getCsrfToken();
      return fetch(url, { ...options, headers, credentials: 'include' });
    }

    async function loadComments(postId) {
      try {
        const res = await fetch(`/api/comments?post_id=${postId}`);
        if (!res.ok) throw new Error('API error');
        const comments = (await res.json()).reverse();
        const list = document.getElementById('comment-list');
        list.innerHTML = comments.length
          ? comments.map(c => `
              <div class="border-b pb-2">
                <div class="flex items-center justify-between mb-1">
                  <div class="text-sm text-slate-500">${c.name || 'Anonymous'} &bull; ${new Date(c.created_at).toLocaleString()}</div>
                  ${currentUser && (currentUser.role === 'admin' || currentUser.id === c.user_id)
                    ? `<button data-id="${c.id}" class="comment-delete text-xs text-red-500 hover:underline">Delete</button>`
                    : ''}
                </div>
                <div>${c.content}</div>
              </div>`).join('')
          : '<p class="text-slate-500">No comments yet.</p>';
      } catch (err) {
        console.error('Failed to load comments', err);
      }
    }

    function setupCommentForm(postId) {
      const form = document.getElementById('comment-form');
      if (!form) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const textarea = document.getElementById('comment-content');
        const content = textarea.value.trim();
        if (!content) return;
        const res = await csrfFetch('/api/comments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ post_id: postId, content })
        });
        if (res.ok) {
          textarea.value = '';
          loadComments(postId);
        } else {
          alert('Failed to post comment');
        }
      });
    }

    async function loadPost() {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get('slug');
      const container = document.getElementById('post-container');
      if (!slug) {
        container.innerHTML = '<p class="text-red-500">No article specified.</p>';
        return;
      }
      try {
        const res = await fetch(`/api/posts/${encodeURIComponent(slug)}`, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('API error');
        const p = await res.json();
        const date = new Date(p.published_at || Date.now()).toLocaleDateString();

        let authHtml = '';
        try {
          const meRes = await fetch('/api/auth/me');
          if (meRes.ok) {
            currentUser = await meRes.json();
            authHtml = `
            <form id="comment-form" class="space-y-2">
              <textarea id="comment-content" class="w-full border rounded p-2" required></textarea>
              <button type="submit" class="bg-primary text-white px-4 py-2 rounded">Post Comment</button>
            </form>`;
          } else {
            authHtml = `<a href="/login" class="text-primary hover:underline">Log in to comment</a>`;
          }
        } catch (err) {
          authHtml = `<a href="/login" class="text-primary hover:underline">Log in to comment</a>`;
        }

        container.innerHTML = `
          <article>
            <h1 class="text-3xl font-bold mb-4">${p.title}</h1>
            <div class="text-sm text-slate-500 mb-6">${date} &bull; ${p.author || 'AI News Hub'}</div>
            <img src="${p.hero_image || p.image_url || 'https://picsum.photos/800/400'}" alt="${p.title}" class="w-full mb-6 rounded">
            <div class="prose dark:prose-invert max-w-none">${p.content || ''}</div>
          </article>
          <section class="mt-12">
            <h2 class="text-2xl font-bold mb-4">Comments</h2>
            <div id="comment-list" class="space-y-4 mb-6"></div>
            ${authHtml}
          </section>`;
        currentPostId = p.id;
        const list = document.getElementById('comment-list');
        list.addEventListener('click', async (e) => {
          const btn = e.target.closest('.comment-delete');
          if (btn) {
            const id = btn.dataset.id;
            const res = await csrfFetch(`/api/comments/${id}`, { method: 'DELETE' });
            if (res.ok) {
              loadComments(currentPostId);
            } else {
              alert('Failed to delete comment');
            }
          }
        });
        loadComments(currentPostId);
        if (currentUser) {
          setupCommentForm(currentPostId);
        }
      } catch (err) {
        container.innerHTML = '<p class="text-red-500">Failed to load article.</p>';
      }
    }
    document.addEventListener('DOMContentLoaded', async () => {
      await ensureCsrfCookie();
      loadPost();
    });
  </script>
</body>
</html>
