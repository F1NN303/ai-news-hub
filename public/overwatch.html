<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Overwatch Stats — AI News Hub</title>

  <!-- Auth0: DO NOT CHANGE -->
  <meta name="auth0-client-id" content="a2MdQnWFC2HOqBY09V4EZ7KOFjj3fXNK">
  <meta name="auth0-domain" content="dev-zi3ojkfg51ob4f3c.eu.auth0.com">
  <meta name="auth0-audience" content="https://ai-news-hub-eta.vercel.app/api">

  <!-- Auth0 SDK + Helper -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
  <script src="/auth/auth.js" defer></script>

  <!-- Theme + Tailwind -->
  <script>
    document.documentElement.dataset.theme = localStorage.theme || 'light';
    if (document.documentElement.dataset.theme === 'dark') document.documentElement.classList.add('dark');
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { primary:'#0ea5e9', secondary:'#06b6d4', dark:'#0f172a', light:'#f8fafc', accent:'#818cf8' },
          fontFamily: { inter: ['Inter','system-ui','sans-serif'] }
        }
      }
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/resources/site.css" />
  <!-- FIX: kein /public Prefix -->
  <script src="/js/cookie-banner.js" defer></script>
</head>

<body class="bg-light dark:bg-dark text-slate-900 dark:text-slate-100 font-inter">
  <!-- Header -->
  <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto flex justify-between items-center p-4">
      <a href="/" class="text-xl font-bold">AI News Hub</a>
      <nav id="main-nav" class="flex items-center gap-4 text-sm">
        <a href="/login" class="hover:underline">Sign in</a>
        <a href="/signup" class="hover:underline">Sign up</a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-6">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-3xl font-bold">Overwatch Profile Lookup</h1>
      <div class="flex items-center gap-2">
        <button id="printBtn" class="text-sm px-3 py-1.5 rounded border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">Print / Save PDF</button>
      </div>
    </div>
    <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">
      Enter a BattleTag (<code>Name#12345</code>). We try <span class="font-semibold">ow-api.com</span> first and fall back to OverFast if needed.
    </p>

    <!-- Search form -->
    <section class="bg-white/70 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 rounded-xl p-4 mb-6">
      <form id="ow-form" class="grid gap-4 md:grid-cols-4">
        <label class="flex flex-col">
          <span class="text-sm mb-1">BattleTag</span>
          <input id="btag" type="text" required placeholder="PlayerName#1234"
                 class="rounded-md px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 outline-none focus:ring-2 focus:ring-primary" />
        </label>

        <label class="flex flex-col">
          <span class="text-sm mb-1">Platform</span>
          <select id="platform" class="rounded-md px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700">
            <option value="pc" selected>PC</option>
            <option value="xbl">Xbox</option>
            <option value="psn">PlayStation</option>
            <option value="nintendo-switch">Switch</option>
          </select>
        </label>

        <label class="flex flex-col">
          <span class="text-sm mb-1">Region</span>
          <select id="region" class="rounded-md px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700">
            <option value="eu" selected>EU</option>
            <option value="us">US</option>
            <option value="asia">Asia</option>
          </select>
        </label>

        <div class="flex items-end gap-2">
          <button type="submit" id="fetchBtn"
            class="px-4 py-2 rounded-md bg-primary text-white hover:opacity-90">Fetch profile</button>
          <button type="button" id="demoBtn"
            class="px-4 py-2 rounded-md border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">Demo tag</button>
        </div>
      </form>

      <!-- Recent lookups -->
      <div id="recentWrap" class="mt-3 hidden">
        <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">Recent:</div>
        <div id="recentList" class="flex flex-wrap gap-2"></div>
      </div>

      <div id="formError" class="mt-3 hidden text-sm text-red-600 dark:text-red-400"></div>
    </section>

    <!-- Results -->
    <section id="results" class="grid gap-6 md:grid-cols-3">
      <!-- left: profile card -->
      <div class="md:col-span-1 border border-slate-200 dark:border-slate-800 rounded-xl p-4 bg-white/70 dark:bg-slate-900/60">
        <div id="card-skel" class="animate-pulse space-y-3">
          <div class="h-24 w-24 rounded-full bg-slate-200 dark:bg-slate-800"></div>
          <div class="h-4 w-40 bg-slate-200 dark:bg-slate-800 rounded"></div>
          <div class="h-4 w-28 bg-slate-200 dark:bg-slate-800 rounded"></div>
        </div>

        <div id="card" class="hidden">
          <img id="p-icon" class="h-24 w-24 rounded-full border border-slate-300 dark:border-slate-700" alt="Player icon" />
          <h2 id="p-name" class="mt-3 text-xl font-semibold"></h2>
          <p id="p-privacy" class="text-sm text-slate-500 dark:text-slate-400"></p>

          <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
            <div class="p-2 rounded border border-slate-200 dark:border-slate-800">
              <div class="text-slate-500 dark:text-slate-400">Level</div>
              <div id="p-level" class="font-semibold">—</div>
            </div>
            <div class="p-2 rounded border border-slate-200 dark:border-slate-800">
              <div class="text-slate-500 dark:text-slate-400">Endorsement</div>
              <div id="p-endorse" class="font-semibold">—</div>
            </div>
            <div class="p-2 rounded border border-slate-200 dark:border-slate-800">
              <div class="text-slate-500 dark:text-slate-400">Rating</div>
              <div id="p-rating" class="font-semibold">—</div>
            </div>
            <div class="p-2 rounded border border-slate-200 dark:border-slate-800">
              <div class="text-slate-500 dark:text-slate-400">Games Won</div>
              <div id="p-won" class="font-semibold">—</div>
            </div>
          </div>
        </div>
      </div>

      <!-- middle: quick play -->
      <div class="md:col-span-1 border border-slate-200 dark:border-slate-800 rounded-xl p-4 bg-white/70 dark:bg-slate-900/60">
        <h3 class="font-semibold mb-2">Quick Play</h3>
        <div id="qp-body" class="text-sm space-y-2 text-slate-700 dark:text-slate-300">
          <div class="h-4 w-40 bg-slate-200 dark:bg-slate-800 rounded animate-pulse"></div>
          <div class="h-4 w-32 bg-slate-200 dark:bg-slate-800 rounded animate-pulse"></div>
        </div>
      </div>

      <!-- right: competitive -->
      <div class="md:col-span-1 border border-slate-200 dark:border-slate-800 rounded-xl p-4 bg-white/70 dark:bg-slate-900/60">
        <h3 class="font-semibold mb-2">Competitive</h3>
        <div id="comp-body" class="text-sm space-y-2 text-slate-700 dark:text-slate-300">
          <div class="h-4 w-40 bg-slate-200 dark:bg-slate-800 rounded animate-pulse"></div>
          <div class="h-4 w-32 bg-slate-200 dark:bg-slate-800 rounded animate-pulse"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 mt-12">
    <div class="max-w-7xl mx-auto p-8 grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-slate-500">
      <div>
        <h3 class="text-slate-800 dark:text-slate-200 font-semibold mb-2">Resources</h3>
        <ul class="space-y-1">
          <li><a href="/resources/glossary.html" class="hover:underline">AI Glossary</a></li>
          <li><a href="/resources/research.html" class="hover:underline">Research Papers</a></li>
          <li><a href="/resources/tutorials.html" class="hover:underline">Tutorials</a></li>
          <li><a href="/resources/events.html" class="hover:underline">Events Calendar</a></li>
        </ul>
      </div>
      <div>
        <h3 class="text-slate-800 dark:text-slate-200 font-semibold mb-2">Legal</h3>
        <ul class="space-y-1">
          <li><a href="/legal/privacy.html" class="hover:underline">Privacy Policy</a></li>
          <li><a href="/legal/terms.html" class="hover:underline">Terms of Service</a></li>
          <li><a href="/legal/cookie-policy.html" class="hover:underline">Cookie Policy</a></li>
        </ul>
      </div>
      <div class="md:text-right flex items-end">
        <p class="w-full text-center md:text-right">© <span id="year"></span> AI News Hub</p>
      </div>
    </div>
    <script>
      document.getElementById('year').textContent = new Date().getFullYear();
      document.getElementById('printBtn').onclick = () => window.print();
    </script>
  </footer>

  <script>
    // Auth avatar injection
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (window.auth && window.auth.ready) {
          await window.auth.ready;
          const isAuthed = await window.auth.isAuthenticated();
          const nav = document.getElementById('main-nav');
          if (isAuthed && nav) {
            const user = await window.auth.getUser();
            nav.innerHTML = `
              <a href="/profile.html" class="flex items-center gap-2 hover:opacity-90">
                <img src="${(user && user.picture) || '/resources/avatar-placeholder.png'}"
                     alt="Profile" class="h-6 w-6 rounded-full border border-slate-300 dark:border-slate-700"/>
                <span>Profile</span>
              </a>`;
          }
        }
      } catch {}
    });

    // Recent lookups
    const RECENT_KEY = 'ow:recent';
    const getRecent = () => { try { return JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); } catch { return []; } }
    const addRecent = (tag, plat, reg) => {
      const list = getRecent().filter(x => x.tag !== tag || x.plat !== plat || x.reg !== reg);
      list.unshift({ tag, plat, reg });
      localStorage.setItem(RECENT_KEY, JSON.stringify(list.slice(0,6)));
      renderRecent();
    }
    const renderRecent = () => {
      const wrap = document.getElementById('recentWrap');
      const box = document.getElementById('recentList');
      const list = getRecent();
      if (!list.length) { wrap.classList.add('hidden'); return; }
      wrap.classList.remove('hidden');
      box.innerHTML = '';
      list.forEach(({tag, plat, reg}) => {
        const a = document.createElement('button');
        a.className = 'px-2 py-1 rounded border border-slate-300 dark:border-slate-700 text-sm hover:bg-slate-50 dark:hover:bg-slate-800';
        a.textContent = `${tag} • ${plat}/${reg}`;
        a.onclick = () => {
          document.getElementById('btag').value = tag;
          document.getElementById('platform').value = plat;
          document.getElementById('region').value = reg;
          document.getElementById('ow-form').dispatchEvent(new Event('submit', {cancelable:true}));
        };
        box.appendChild(a);
      });
    };

    // Demo
    document.getElementById('demoBtn').addEventListener('click', () => {
      document.getElementById('btag').value = 'xQc#11273';
      document.getElementById('platform').value = 'pc';
      document.getElementById('region').value = 'us';
    });

    // ------- Robust fetch with fallback -------
    const $ = (id) => document.getElementById(id);
    const showError = (msg) => {
      const box = $('formError');
      box.textContent = msg || 'Something went wrong.';
      box.classList.remove('hidden');
      console.error(msg);
    };
    const clearError = () => $('formError').classList.add('hidden');
    const fmt = (v, d='—') => (v === 0 ? '0' : (v ? v : d));
    const safeNum = (v) => (typeof v === 'number' && isFinite(v)) ? v : null;

    const fillProfile = (data) => {
      $('card-skel').classList.add('hidden');
      $('card').classList.remove('hidden');
      $('p-icon').src = data?.icon || '';
      $('p-name').textContent = data?.name || 'Unknown';
      $('p-privacy').textContent = data?.private ? 'Private profile' : '';
      $('p-level').textContent = fmt(data?.level ?? data?.summary?.level);
      $('p-endorse').textContent = fmt(data?.endorsement ?? data?.summary?.endorsement);
      $('p-rating').textContent = fmt(data?.rating ?? data?.summary?.rating);
      const qpWon = data?.quickPlayStats?.games?.won ?? data?.modes?.quickplay?.games_won;
      const compWon = data?.competitiveStats?.games?.won ?? data?.modes?.competitive?.games_won;
      $('p-won').textContent = fmt(qpWon ?? compWon);
    };

    const fillQuickPlay = (data) => {
      const root = $('qp-body');
      const games = data?.quickPlayStats?.games || data?.modes?.quickplay || {};
      const awards = data?.quickPlayStats?.awards || {};
      root.innerHTML = `
        <div><span class="text-slate-500 dark:text-slate-400">Games:</span>
          Won ${fmt(games?.won)}${games?.played ? ` / Played ${games.played}` : ''}</div>
        <div><span class="text-slate-500 dark:text-slate-400">Medals:</span>
          Gold ${fmt(awards?.medalsGold)} • Silver ${fmt(awards?.medalsSilver)} • Bronze ${fmt(awards?.medalsBronze)}</div>`;
    };

    const fillCompetitive = (data) => {
      const root = $('comp-body');
      const games = data?.competitiveStats?.games || data?.modes?.competitive || {};
      const awards = data?.competitiveStats?.awards || {};
      const win = safeNum(games.won), lost = safeNum(games.lost), played = safeNum(games.played);
      const wr = (win != null && played) ? Math.round((win/played)*100) + '%' : '—';
      root.innerHTML = `
        <div><span class="text-slate-500 dark:text-slate-400">Games:</span>
          Won ${fmt(win)}${lost!=null?` • Lost ${lost}`:''}${played?` • Played ${played}`:''}</div>
        <div><span class="text-slate-500 dark:text-slate-400">Win rate:</span> ${wr}</div>
        <div><span class="text-slate-500 dark:text-slate-400">Medals:</span>
          Gold ${fmt(awards?.medalsGold)} • Silver ${fmt(awards?.medalsSilver)} • Bronze ${fmt(awards?.medalsBronze)}</div>`;
    };

    async function fetchJSON(url) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 10000);
      const r = await fetch(url, { headers:{Accept:'application/json'}, signal: ctrl.signal });
      clearTimeout(t);
      const text = await r.text();
      if (!r.ok) throw new Error(`HTTP ${r.status}: ${text || r.statusText}`);
      return text ? JSON.parse(text) : null;
    }

    const dashTag = (raw) => raw.trim().replace('#','-');

    async function queryOW(platform, region, btagRaw) {
      // primary
      const url1 = `https://ow-api.com/v1/stats/${platform}/${region}/${encodeURIComponent(dashTag(btagRaw))}/profile`;
      try {
        return await fetchJSON(url1);
      } catch (e) {
        // fallback
        console.warn('Primary failed, fallback → OverFast', e);
        const url2 = `https://overfast-api.tekrop.fr/players/${platform}/${dashTag(btagRaw)}`;
        return await fetchJSON(url2);
      }
    }

    document.getElementById('ow-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();

      const raw = document.getElementById('btag').value.trim();
      if (!raw || !/#/.test(raw)) return showError('Please enter BattleTag as Name#1234');

      const platform = document.getElementById('platform').value;
      const region = document.getElementById('region').value;

      // reset UI
      document.getElementById('card').classList.add('hidden');
      document.getElementById('card-skel').classList.remove('hidden');
      document.getElementById('qp-body').innerHTML = `<div class="h-4 w-40 bg-slate-200 dark:bg-slate-800 rounded animate-pulse"></div>`;
      document.getElementById('comp-body').innerHTML = `<div class="h-4 w-40 bg-slate-200 dark:bg-slate-800 rounded animate-pulse"></div>`;

      try {
        const data = await queryOW(platform, region, raw);
        if (!data || data.error) throw new Error(data?.error || 'No data returned.');
        fillProfile(data);
        fillQuickPlay(data);
        fillCompetitive(data);
        addRecent(raw, platform, region);
      } catch (err) {
        document.getElementById('card-skel').classList.add('hidden');
        showError(err?.message || 'Failed to fetch profile.');
      }
    });

    // Init
    renderRecent();
  </script>
</body>
</html>
