<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Profile</title>

  <!-- These 3 meta tags must already be injected by your script or build step -->
  <meta name="auth0-client-id" content="">
  <meta name="auth0-domain" content="">
  <meta name="auth0-audience" content="">

  <!-- Shared site styles (keep these if you already use them) -->
  <link rel="stylesheet" href="/resources/site.css">
  <script defer src="/resources/site.js"></script>

  <!-- Page-only polish (tiny, safe to keep inline) -->
  <style>
    :root {
      --card-bg: #0f172a;
      --card-fg: #e2e8f0;
      --muted: #94a3b8;
      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --ring: rgba(59,130,246,.35);
      --link: #3b82f6;
      --chip: #1f2937;
      --chip-fg: #cbd5e1;
      --border: rgba(148,163,184,.2);
      --surface: #0b1220;
      --page: #0a1020;
      color-scheme: light dark;
    }
    [data-theme="light"] {
      --page: #f8fafc;
      --surface: #ffffff;
      --card-bg: #ffffff;
      --card-fg: #0f172a;
      --muted: #475569;
      --chip: #e5e7eb;
      --chip-fg: #111827;
      --border: rgba(15,23,42,.08);
    }
    html, body { margin: 0; height: 100%; background: var(--page); color: var(--card-fg); font: 16px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:24px; }
    header h1 { font-size: clamp(20px, 3vw, 28px); margin:0; }
    .theme-toggle { border:1px solid var(--border); background:var(--surface); border-radius:999px; padding:6px 10px; cursor:pointer; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 880px){ .grid { grid-template-columns: 2fr 1fr; } }

    .card { background:var(--card-bg); color:var(--card-fg); border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow: 0 1px 0 rgba(0,0,0,.05); }
    .row { display:flex; align-items:center; gap:14px; flex-wrap:wrap; }
    .avatar { width:72px; height:72px; border-radius:50%; object-fit:cover; background:#0b1220; border: 2px solid var(--border); }
    .name { font-size:20px; font-weight:700; display:flex; align-items:center; gap:8px; }
    .chip { display:inline-flex; align-items:center; gap:6px; background:var(--chip); color:var(--chip-fg); border-radius:999px; padding:4px 10px; font-size:12px; }
    .verified { color: var(--ok); }
    .muted { color: var(--muted); }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:8px 12px; margin-top:12px; }
    .kv div:nth-child(odd){ color:var(--muted); }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .btn { border:1px solid var(--border); background:var(--surface); color:var(--card-fg); padding:10px 14px; border-radius:12px; cursor:pointer; text-decoration:none; }
    .btn.primary { background:#2563eb; color:#fff; border-color:#1d4ed8; }
    .btn.danger  { background: #fee2e2; color:#991b1b; border-color:#fecaca; }
    [data-theme="light"] .btn.danger { background: #fee2e2; }
    details { border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:var(--surface); }
    details > summary { cursor:pointer; list-style: none; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    pre { background: var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px; overflow:auto; }
    .roles { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .empty { padding:18px; border:1px dashed var(--border); border-radius:12px; text-align:center; color:var(--muted); }
    .warn { color: var(--warn); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Profile</h1>
      <button class="theme-toggle" id="themeToggle" title="Toggle theme">üåì</button>
    </header>

    <noscript>
      <p class="empty">This page needs JavaScript to display your Auth0 profile.</p>
    </noscript>

    <section class="grid" id="profileGrid" hidden>
      <!-- Left column -->
      <div class="left">
        <div class="card" id="cardOverview">
          <div class="row">
            <img id="avatar" class="avatar" alt="Avatar">
            <div style="min-width:240px">
              <div class="name">
                <span id="displayName">‚Äî</span>
                <span id="verifiedBadge" class="chip verified" title="Email verified" hidden>‚úî Verified</span>
                <span id="adminBadge" class="chip" title="Admin" hidden>‚öô Admin</span>
              </div>
              <div class="muted" id="emailLine">‚Äî</div>
            </div>
          </div>

          <div class="kv">
            <div>User ID</div><div id="sub">‚Äî</div>
            <div>Updated</div><div id="updatedAt">‚Äî</div>
            <div>Auth Status</div><div id="authStatus">‚Äî</div>
          </div>

          <div class="actions">
            <a class="btn" href="/">‚Üê Back to Home</a>
            <button id="btnManagePwd" class="btn">Change password</button>
            <button id="btnLogout" class="btn danger">Sign out</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px">Roles & Permissions</h3>
          <div id="rolesWrap" class="roles"></div>
          <div id="noRoles" class="empty" hidden>No roles found for this account.</div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px">Account details (raw)</h3>
          <details>
            <summary>Show JSON</summary>
            <pre id="jsonDump" aria-live="polite">{}</pre>
          </details>
        </div>
      </div>

      <!-- Right column -->
      <aside class="right">
        <div class="card">
          <h3 style="margin:0 0 8px">Security</h3>
          <ul style="margin:0; padding-left:18px">
            <li>Email verification: <strong id="emailVerified">‚Äî</strong></li>
            <li>Token scope (if available): <code id="tokenScope">‚Äî</code></li>
          </ul>
          <div id="securityHint" class="muted" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px">Shortcuts</h3>
          <ul style="margin:0; padding-left:18px">
            <li><a class="link" href="/admin/index.html" id="adminLink" hidden>Open Admin Dashboard</a></li>
            <li><a class="link" href="/legal/privacy.html">Privacy</a></li>
            <li><a class="link" href="/legal/terms.html">Terms</a></li>
          </ul>
        </div>

        <div class="card" id="notLogged" hidden>
          <p class="warn"><strong>Not signed in.</strong></p>
          <p><a class="btn primary" href="/login">Sign in</a></p>
        </div>
      </aside>
    </section>
  </div>

  <!-- Auth client (your existing wrapper) -->
  <script src="/auth/auth.js"></script>
  <script>
    (function () {
      const $ = (s, r = document) => r.querySelector(s);
      const setText = (id, v) => { const el = typeof id === 'string' ? $(id) : id; if (el) el.textContent = v ?? '‚Äî'; };
      const setHidden = (el, hidden) => { if (el) el.hidden = !!hidden; };

      const themeBtn = $('#themeToggle');
      themeBtn?.addEventListener('click', () => {
        const root = document.documentElement;
        const next = (root.dataset.theme === 'dark') ? 'light' : 'dark';
        root.dataset.theme = next;
        localStorage.theme = next;
      });
      // apply persisted theme
      document.documentElement.dataset.theme = localStorage.theme || document.documentElement.dataset.theme || 'light';

      function ensureAuthReady() {
        // window.__auth is set by auth.js once initialized
        if (window.__auth) return Promise.resolve(window.__auth);
        return new Promise((res) => {
          window.addEventListener('auth:ready', () => res(window.__auth), { once: true });
        });
      }

      function renderProfile(auth) {
        const grid = $('#profileGrid');
        const notLogged = $('#notLogged');
        if (!auth?.isAuthenticated) {
          setHidden(grid, true);
          setHidden(notLogged, false);
          return;
        }

        setHidden(notLogged, true);
        setHidden(grid, false);

        const u = auth.user || {};
        const avatar = $('#avatar');
        avatar.src = u.picture || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.name || u.nickname || 'User');
        avatar.alt = (u.name || u.nickname || 'User') + ' avatar';

        const name = u.name || u.nickname || '(no name)';
        setText('#displayName', name);
        setText('#emailLine', u.email || '(no email)');
        setHidden($('#verifiedBadge'), !u.email_verified);
        setHidden($('#adminBadge'), !auth.isAdmin);

        setText('#sub', u.sub || '‚Äî');
        setText('#updatedAt', u.updated_at ? new Date(u.updated_at).toLocaleString() : '‚Äî');
        setText('#authStatus', auth.isAuthenticated ? 'Authenticated' : '‚Äî');
        setText('#emailVerified', u.email_verified ? 'Yes' : 'No');

        // Roles (supports namespaced or plain)
        const roleClaim = u['https://ai-news-hub/roles'] || u.roles || [];
        const roles = Array.isArray(roleClaim) ? roleClaim :
                      (typeof roleClaim === 'string' ? roleClaim.split(/\s+/) : []);
        const rolesWrap = $('#rolesWrap');
        rolesWrap.innerHTML = '';
        if (!roles.length) {
          setHidden($('#noRoles'), false);
        } else {
          setHidden($('#noRoles'), true);
          roles.forEach(r => {
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.textContent = r;
            rolesWrap.appendChild(chip);
          });
        }

        // Raw JSON
        $('#jsonDump').textContent = JSON.stringify(u, null, 2);

        // Token scope (if we can fetch one silently)
        (async () => {
          try {
            const token = await auth.getApiToken?.();
            if (!token) return;
            const payload = JSON.parse(atob(token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
            setText('#tokenScope', Array.isArray(payload.scope) ? payload.scope.join(' ') : (payload.scope || '‚Äî'));
          } catch {}
        })();
      }

      // Actions
      $('#btnLogout').addEventListener('click', () => location.href = '/logout');
      $('#btnManagePwd').addEventListener('click', () => {
        // Universal Logout / password change: send to hosted page
        // If you have a dedicated route, update this link:
        location.href = '/login?action=reset';
      });

      // Kick off
      ensureAuthReady().then(renderProfile);
    })();
  </script>
</body>
</html>
