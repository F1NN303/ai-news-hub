<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Profile</title>

  <!-- DO NOT CHANGE: injected by your build step -->
  <meta name="auth0-client-id" content="a2MdQnWFC2HOqBY09V4EZ7KOFjj3fXNK">
  <meta name="auth0-domain" content="dev-zi3ojkfg51ob4f3c.eu.auth0.com">
  <meta name="auth0-audience" content="https://ai-news-hub-eta.vercel.app/api">

  <!-- Site-wide resources (if present) -->
  <link rel="stylesheet" href="/resources/site.css" />

  <!-- Load Auth0 SDK first, then your helper -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
  <script src="/auth/auth.js" defer></script>

  <style>
    :root{
      --bg: #0b1226; --fg:#e2e8f0; --muted:#94a3b8; --link:#60a5fa;
      --card:#0f172a; --border:#1e293b; --chip:#1f2937;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --shadow: 0 8px 28px rgba(2,6,23,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 700px at 20% -10%, rgba(59,130,246,.12), transparent 60%),
                 radial-gradient(900px 600px at 100% 10%, rgba(99,102,241,.10), transparent 60%), var(--bg);
      color:var(--fg); font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }
    a{color:var(--link); text-decoration:none}
    .wrap{max-width:1100px; margin:28px auto; padding:0 20px}

    /* Page header */
    .page-head{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px}
    .title{display:flex; align-items:center; gap:10px}
    .title .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,#60a5fa,#22d3ee)}
    h1{font-size:1.9rem; margin:0; letter-spacing:.2px}
    .back{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#0b1428}
    .back:hover{border-color:#2b3a55}

    /* Layout */
    .layout{display:grid; grid-template-columns: 1.35fr .9fr; gap:18px}
    @media (max-width:920px){ .layout{grid-template-columns:1fr} }

    .card{
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .card h2{font-size:1.05rem; margin:0 0 12px; color:#cbd5e1; letter-spacing:.2px}

    /* Profile header block */
    .profile{
      display:flex; gap:18px; align-items:center; flex-wrap:wrap;
      border-bottom:1px dashed rgba(148,163,184,.18); padding-bottom:14px; margin-bottom:14px;
    }
    .avatar{width:84px;height:84px;border-radius:50%; background:#0b1428; border:1px solid var(--border)}
    .identity{display:flex; flex-direction:column; gap:6px}
    .name{font-size:1.15rem; font-weight:600}
    .email{color:var(--muted); font-size:.95rem}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      background:var(--chip); border:1px solid var(--border); border-radius:999px; color:#cbd5e1; font-size:.8rem;
    }
    .chip.ok{border-color:rgba(16,185,129,.45)}
    .chip.admin{border-color:rgba(99,102,241,.45)}

    .kv{display:grid; grid-template-columns:160px 1fr; gap:8px 12px}
    .label{color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9rem}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      padding:10px 14px; border-radius:10px; border:1px solid var(--border); color:var(--fg); background:#0b1428; cursor:pointer;
    }
    .btn:hover{border-color:#2b3a55}
    .btn.primary{background:linear-gradient(135deg,#2563eb,#0891b2); border:0}
    .btn.danger{background:#1d1b22; border-color:#3b1f25; color:#fecaca}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* Secondary blocks */
    .list{display:grid; gap:6px; margin-top:6px}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:#0b1428; border:1px solid var(--border); font-size:.85rem}
    .muted{color:var(--muted)}

    /* JSON viewer */
    details summary{cursor:pointer; color:#cbd5e1}
    pre{
      margin:10px 0 0; padding:12px; border-radius:12px; background:#0b1428; border:1px solid var(--border);
      max-height:360px; overflow:auto; font-size:.9rem;
    }

    /* Error + skeleton */
    .banner{
      display:none; padding:10px 14px; border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.08); color:#fecaca; border-radius:12px; margin:0 0 16px;
    }
    .skeleton{position:relative; overflow:hidden; background:#0b1428; border-radius:10px}
    .skeleton::after{
      content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg, transparent, rgba(148,163,184,.12), transparent);
      animation:shimmer 1.2s infinite;
    }
    @keyframes shimmer{100%{transform:translateX(100%)}}

    /* Copy button */
    .copy{margin-left:8px; padding:4px 8px; border-radius:8px; border:1px solid var(--border); background:#0b1428; color:#cbd5e1; font-size:.8rem}
    .copy.ok{border-color:rgba(16,185,129,.5); color:#bbf7d0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="page-head">
      <div class="title"><span class="dot"></span><h1>Profile</h1></div>
      <a href="/" class="back">‚Üê Back to Home</a>
    </div>

    <div id="authError" class="banner">Authentication is currently unavailable. Please try again later.</div>

    <div class="layout">
      <!-- Left: main profile -->
      <section class="card">
        <div class="profile">
          <img id="avatar" class="avatar skeleton" alt="Avatar" />
          <div class="identity">
            <div id="name" class="name skeleton" style="width:240px;height:20px"></div>
            <div id="email" class="email skeleton" style="width:280px;height:16px"></div>
            <div class="chips">
              <span id="verifiedChip" class="chip ok" style="display:none">‚úì Verified</span>
              <span id="adminChip" class="chip admin" style="display:none">üõ° Admin</span>
            </div>
          </div>
        </div>

        <div class="kv">
          <div class="label">User ID</div>
          <div><span id="userId" class="mono">‚Äî</span> <button id="copyId" class="copy" title="Copy ID">Copy</button></div>

          <div class="label">Updated</div>
          <div id="updatedAt" class="muted">‚Äî</div>

          <div class="label">Auth Status</div>
          <div id="authStatus" class="muted">‚Äî</div>
        </div>

        <div class="toolbar">
          <a id="pwdLink" class="btn">Change password</a>
          <button id="signOutBtn" class="btn danger">Sign out</button>
        </div>
      </section>

      <!-- Right: security & quick links -->
      <aside class="card">
        <h2>Security</h2>
        <div class="list">
          <div><span class="label">Email verification:</span> <span id="emailVerified" class="muted">‚Äî</span></div>
          <div><span class="label">Token scope (if available):</span> <span id="tokenScope" class="muted">‚Äî</span></div>
        </div>

        <div style="height:10px"></div>
        <h2>Shortcuts</h2>
        <div class="list">
          <a class="pill" href="/legal/privacy.html">Privacy</a>
          <a class="pill" href="/legal/terms.html">Terms</a>
        </div>
      </aside>

      <!-- Roles -->
      <section class="card">
        <h2>Roles & Permissions</h2>
        <div class="list">
          <div><span class="label">Roles:</span> <span id="roles" class="muted">‚Äî</span></div>
          <div><span class="label">Permissions:</span> <span id="perms" class="muted">‚Äî</span></div>
        </div>
      </section>

      <!-- Raw JSON -->
      <section class="card">
        <h2>Account details (raw)</h2>
        <details>
          <summary>Show JSON</summary>
          <pre id="rawJson" aria-live="polite"></pre>
        </details>
      </section>
    </div>
  </div>

  <script>
  // Run only after all deferred scripts (incl. /auth/auth.js) are executed
  window.addEventListener('load', () => {
    (async () => {
      const $ = (id) => document.getElementById(id);
      const showErr = (msg) => { const b = $('authError'); if (b) { b.textContent = msg || b.textContent; b.style.display = 'block'; } };
      const set = (id, v) => { const el = $(id); if (!el) return; el.textContent = v; el.classList.remove('skeleton'); };

      // Wait up to 6s for /auth/auth.js to attach window.auth.ready
      async function waitForAuthHelper(timeoutMs = 6000) {
        const start = Date.now();
        while (!(window.auth && window.auth.ready)) {
          if (Date.now() - start > timeoutMs) throw new Error('auth helper timeout');
          await new Promise(r => setTimeout(r, 50));
        }
      }

      try {
        await waitForAuthHelper();
        await window.auth.ready; // promise set by /auth/auth.js
      } catch (e) {
        console.error(e);
        showErr('Auth helper not available');
        return;
      }

      const isAuthed = await window.auth.isAuthenticated();
      const user = isAuthed ? await window.auth.getUser() : null;
      if (!isAuthed || !user) { showErr('Signed out'); set('authStatus','Signed out'); return; }

      // Fill identity
      const avatar = $('avatar');
      avatar.classList.remove('skeleton');
      avatar.src = user.picture || '';
      avatar.alt = user.name || user.email || 'Avatar';
      set('name',  user.name  || '‚Äî');
      set('email', user.email || '‚Äî');
      if (user.email_verified) $('verifiedChip').style.display = 'inline-flex';

      // Roles via custom claim or array
      const claim = user['https://ai-news-hub/roles'] || user['https://ai-news-hub/roles/'] || user.roles || [];
      const roles = Array.isArray(claim) ? claim : (typeof claim === 'string' ? claim.split(' ') : []);
      if (roles.includes('admin')) $('adminChip').style.display = 'inline-flex';

      $('userId').textContent = user.sub || '‚Äî';
      $('copyId').addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(user.sub || ''); $('copyId').classList.add('ok'); $('copyId').textContent = 'Copied'; setTimeout(()=>{$('copyId').classList.remove('ok'); $('copyId').textContent='Copy';},1200); } catch {}
      });

      set('updatedAt', user.updated_at ? new Date(user.updated_at).toLocaleString() : '‚Äî');
      set('authStatus', 'Signed in');
      $('roles').textContent = roles.length ? roles.join(', ') : '‚Äî';

      // Token info (scope/permissions) from ID token if available
      let scopeText = '‚Äî';
      try {
        const idc = await window.auth.getIdTokenClaims?.();
        if (idc && idc.__raw) {
          const payload = JSON.parse(atob((idc.__raw.split('.')[1]||'').replace(/-/g,'+').replace(/_/g,'/')));
          if (payload?.scope) scopeText = payload.scope;
          const perms = payload?.permissions || [];
          $('perms').textContent = perms.length ? perms.join(', ') : '‚Äî';
        }
      } catch {}
      set('tokenScope', scopeText);

      // Raw JSON
      $('rawJson').textContent = JSON.stringify(user, null, 2);

      // Change password & logout
      const domain   = document.querySelector('meta[name="auth0-domain"]').content.trim();
      const clientId = document.querySelector('meta[name="auth0-client-id"]').content.trim();
      const returnTo = window.location.origin + '/';
      $('pwdLink').href = `https://${domain}/u/reset-password/request/index?client_id=${encodeURIComponent(clientId)}&returnTo=${encodeURIComponent(returnTo)}`;

      $('signOutBtn').addEventListener('click', async () => {
        try { await window.auth.logout(); }
        catch { window.location.href = `https://${domain}/v2/logout?client_id=${encodeURIComponent(clientId)}&returnTo=${encodeURIComponent(returnTo)}`; }
      });
    })();
  });
</script>
</body>
</html>
